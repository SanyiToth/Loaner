<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_1068794_loaner.LoanerUtils</api_name>
        <caller_access/>
        <client_callable>true</client_callable>
        <description/>
        <name>LoanerUtils</name>
        <script><![CDATA[var LoanerUtils = Class.create();
LoanerUtils.prototype = {
    initialize: function() {},
    validateDates: function() {
        var MAX_MONTHS_START_DATE = 3; // Allow reservations with start date within 3 months
        var MAX_MONTHS_RETURN_DATE = 6; // Allow reservations with return date within 6 months from start date
        var startDateUserFormat = this.getParameter('sysparm_startdate');
        var startDate = HAMUtils.getDateInInternalFormat(startDateUserFormat);
        var returnDateUserFormat = this.getParameter('sysparm_returndate');
        var returnDate = HAMUtils.getDateInInternalFormat(returnDateUserFormat);
        var gDate = new GlideDateTime();
        var currentDate = gDate.getLocalDate();
        var res = {};
        var sdt;
        if (!gs.nil(startDate)) {
            sdt = new GlideDateTime(startDate);
            var cdt = new GlideDateTime(currentDate);
            var maxsdt = new GlideDateTime(currentDate);
            maxsdt.addMonthsUTC(MAX_MONTHS_START_DATE);
            if (sdt.before(cdt)) {
                res.isStartDateValid = false;
                res.startDateErrorMsg = gs.getMessage(
                    '{0} is not valid. Select a start date on or after current date!', [startDate]
                );
            } else if (sdt.after(maxsdt)) {
                res.isStartDateValid = false;
                res.startDateErrorMsg = gs.getMessage(
                    '{0} is not valid. Select a start date within {1} months from current date!',
                    [startDate, String(MAX_MONTHS_START_DATE)]
                );
            } else {
                res.isStartDateValid = true;
            }
        }
        if (!gs.nil(returnDate)) {
            sdt = new GlideDateTime(startDate);
            var rdt = new GlideDateTime(returnDate);
            var maxrdt = new GlideDateTime(startDate);
            maxrdt.addMonthsUTC(MAX_MONTHS_RETURN_DATE);
            if (rdt.onOrBefore(sdt)) {
                res.isReturnDateValid = false;
                res.returnDateErrorMsg = gs.getMessage(
                    '{0} is not valid. Select a return date after the selected start date!', [returnDate]
                );
            } else if (rdt.after(maxrdt)) {
                res.isReturnDateValid = false;
                res.returnDateErrorMsg = gs.getMessage(
                    '{0} is not valid. Select a return date within {1} months from the selected start date!',
                    [returnDate, String(MAX_MONTHS_RETURN_DATE)]
                );
            } else {
                res.isReturnDateValid = true;
            }
        }
        return JSON.stringify(res);
    },

    getAllLoanerModels: function() {
        var modelCounts = {};
        var assetsGr = new GlideRecord('alm_asset');
        assetsGr.addQuery('stockroom.name', 'Domat/Ems').addOrCondition('stockroom.name', 'Bonaduz');
        // assetsGr.addQuery('install_status', 6);
        assetsGr.query();
        while (assetsGr.next()) {
            var modelName = assetsGr.model.sys_id.toString();
            if (!modelCounts[modelName]) {
                modelCounts[modelName] = 1;
            } else {
                modelCounts[modelName]++;
            }
        }
        return modelCounts;
    },


    getAllLoanerModelsInUse: function(startDate, returnDate) {
        var modelCountsInUse = {};
        var assetsGa = new GlideAggregate('x_1068794_loaner_asset_order');
        assetsGa.addQuery('start_date', '<=', returnDate);
        assetsGa.addQuery('return_date', '>=', startDate);
        assetsGa.query();
        while (assetsGa.next()) {
            var modelName = assetsGa.model.sys_id.toString();
            if (!modelCountsInUse[modelName]) {
                modelCountsInUse[modelName] = 1;
            } else {
                modelCountsInUse[modelName]++;
            }
        }
        return modelCountsInUse;
    },

    getAvailableLoanerModels: function(startDate, returnDate) {
        var filter;
        var availableModels = [];
        var modelCounts = this.getAllLoanerModels();
        var modelsInUse = this.getAllLoanerModelsInUse(startDate, returnDate);
        for (var modelName in modelCounts) {
            if (modelCounts.hasOwnProperty(modelName)) {
                var count = modelCounts[modelName] || 0;
                var countInUse = modelsInUse[modelName] || 0;

                if (count > countInUse) {
                    availableModels.push(modelName);
                }
            }
        }
        filter = 'sys_idIN' + availableModels;
        return filter;
    },


    getAvailableStockrooms: function(modelDisplayName) {
        var filter;
        var stockroomsarray = [];
        var assetsGa = new GlideAggregate('alm_asset');
        assetsGa.addQuery('model.display_name', modelDisplayName);
        assetsGa.setGroup(true);
        assetsGa.groupBy('stockroom.sys_id');
        assetsGa.query();
        while (assetsGa.next()) {
            stockroomsarray.push(assetsGa.getValue('stockroom.sys_id'));
        }
        filter = 'sys_idIN' + stockroomsarray;
        return filter;
    },

    type: 'LoanerUtils'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-08-22 18:39:25</sys_created_on>
        <sys_id>71baa33197bc7110db793dafe153af01</sys_id>
        <sys_mod_count>14</sys_mod_count>
        <sys_name>LoanerUtils</sys_name>
        <sys_package display_value="Loaner" source="x_1068794_loaner">5a84b41697247110db793dafe153af8b</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Loaner">5a84b41697247110db793dafe153af8b</sys_scope>
        <sys_update_name>sys_script_include_71baa33197bc7110db793dafe153af01</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-08-23 07:58:24</sys_updated_on>
    </sys_script_include>
</record_update>
